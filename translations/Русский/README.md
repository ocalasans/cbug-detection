# Cbug Detection

**Cbug Detection** — это гибкий include для **San Andreas Multiplayer (SA-MP)**, предназначенный для обнаружения эксплойта **C-Bug**, техники, позволяющей игрокам стрелять быстрее, чем предусмотрено, за счёт использования игровых механик. Этот **include** предоставляет **разработчикам серверов** надёжный инструмент для выявления использования **C-Bug**, обеспечивая интеграцию с системами античитов, мониторинга поведения или пользовательскими правилами игры.

В контексте **SA-MP**, **C-Bug** — это практика, включающая быстрые действия, такие как приседание или смена оружия после выстрела, что сокращает время перезарядки и даёт несправедливое преимущество в боях. Этот **include** точно определяет такие действия, что делает его полезным для серверов **Roleplay (RP)**, **Team Deathmatch (TDM)**, **Deathmatch (DM)**, мини-игр или любых сценариев, требующих строгого контроля игровых механик. Его универсальность позволяет использовать его не только для античитов, но и для анализа игрового процесса или создания уникальных механик.

> [!NOTE]
> **Cbug Detection** не ограничивается блокировкой **C-Bug**; его можно интегрировать в системы мониторинга, специальные события или мини-игры с пользовательскими правилами. **В итоге разработчики сами решают, какое действие должно произойти, когда игрок будет замечен за использованием C-Bug**, что обеспечивает широкую гибкость в применении в зависимости от контекста сервера.

## Языки

- Português: [README](../../)
- Deutsch: [README](../Deutsch/README.md)
- English: [README](../English/README.md)
- Español: [README](../Espanol/README.md)
- Français: [README](../Francais/README.md)
- Italiano: [README](../Italiano/README.md)
- Polski: [README](../Polski/README.md)
- Svenska: [README](../Svenska/README.md)
- Türkçe: [README](../Turkce/README.md)

## Содержание

- [Cbug Detection](#cbug-detection)
  - [Языки](#языки)
  - [Содержание](#содержание)
  - [Функционал](#функционал)
  - [Как это работает](#как-это-работает)
    - [Логика обнаружения](#логика-обнаружения)
    - [Отслеживаемые события](#отслеживаемые-события)
    - [Настройки (Defines)](#настройки-defines)
  - [Структура кода](#структура-кода)
  - [Установка и настройка](#установка-и-настройка)
    - [Установка](#установка)
    - [Настройка](#настройка)
  - [Как использовать](#как-использовать)
    - [Активация для игрока](#активация-для-игрока)
    - [Деактивация для игрока](#деактивация-для-игрока)
    - [Проверка состояния](#проверка-состояния)
    - [Интеграция с античитом](#интеграция-с-античитом)
    - [Логирование обнаружений](#логирование-обнаружений)
    - [Пример в мини-игре](#пример-в-мини-игре)
  - [Возможные применения](#возможные-применения)
  - [Кастомизация](#кастомизация)
    - [Настройка Defines](#настройка-defines)
    - [Кастомизация Callback](#кастомизация-callback)
  - [Тестирование и валидация](#тестирование-и-валидация)
  - [Ограничения и замечания](#ограничения-и-замечания)
  - [Лицензия](#лицензия)
    - [Условия:](#условия)

## Функционал

- **Полное обнаружение C-Bug**: Определяет следующие варианты:
  - Classic
  - Rollbug
  - Quick C-switch
  - Jumpbug
  - Run Bug
  - Slide C-Bug
  - Быстрые выстрелы
- **Контроль по игрокам**: Включает или отключает обнаружение для каждого игрока индивидуально.
- **Адаптация под пинг**: Корректирует время обнаружения в зависимости от пинга игрока, минимизируя ложные срабатывания.
- **Защита от ложных срабатываний**: Проверяет состояние игрока, оружие, боеприпасы и анимации для обеспечения точности.
- **Настраиваемые параметры**: Определяет параметры обнаружения через константы (`defines`), хотя стандартные значения оптимизированы.
- **Расширяемый Callback**: Callback `CbugDetection_OnDetected` позволяет интегрировать с пользовательскими системами.
- **Лёгкий и оптимизированный**: Использует только `OnPlayerKeyStateChange` и `OnPlayerWeaponShot`, с минимальным влиянием на производительность.

## Как это работает

Include отслеживает действия игроков через callback'и **OnPlayerKeyStateChange** и **OnPlayerWeaponShot**, используя систему **оценки подозрительности** (`cbug_d_suspicion_score`) для выявления паттернов **C-Bug**. Когда оценка превышает настраиваемый порог (`CBUG_D_SUSPICION_THRESHOLD`), вызывается callback `CbugDetection_OnDetected`.

> [!IMPORTANT]
> Система разработана для надёжности с жёсткими проверками, минимизирующими **ложные срабатывания**, **хотя в редких случаях они возможны**, как указано в разделе ограничений.

### Логика обнаружения
1. **Оценка подозрительности**:
   - Подозрительные действия (например, приседание, смена оружия, быстрые выстрелы) увеличивают `cbug_d_suspicion_score` с определёнными весами.
   - Пример: Приседание после выстрела добавляет **4.0** очков; быстрые выстрелы добавляют **3.0** очков.
   - Оценка уменьшается со временем (`CBUG_D_SUSPICION_DECAY = 0.5` в секунду), чтобы избежать накопления несвязанных действий.

2. **Временные окна**:
   - Действия считаются подозрительными, если происходят сразу после выстрела (`CBUG_D_SEQUENCE_INTERVAL = 1500ms`).
   - Быстрые выстрелы обнаруживаются, если происходят в течение `CBUG_D_SHOT_INTERVAL = 200ms`.

3. **Проверки**:
   - Отслеживаются только определённые виды оружия (`CBUG_D_VALID_WEAPONS`: **Desert Eagle**, **Shotgun**, **SPAS-12**, **Rifle**, **Sniper**).
   - Обнаружение отключается, если:
     - Игрок не находится в состоянии пешего передвижения (`PLAYER_STATE_ONFOOT`).
     - Игрок бежит или прыгает (проверяется по анимациям).
     - Нет боеприпасов (`GetPlayerAmmo(playerid) <= 0`).
     - Обнаружение отключено для игрока (`cbug_d_player_status`).

4. **Корректировка по пингу**:
   - Функция `CbugDetection_GetPingAdjtThresh` корректирует время в зависимости от пинга:
     ```pawn
     static stock Float:CbugDetection_GetPingAdjtThresh(playerid, cbug_d_base_threshold)
         return float(cbug_d_base_threshold) + (float(GetPlayerPing(playerid)) * CBUG_D_PING_MULTIPLIER);
     ```
   - Это обеспечивает справедливость для игроков с высокой задержкой (например, **200**-**300ms**).

5. **Период восстановления**:
   - Интервал (`CBUG_D_COOLDOWN_TIME = 1500ms`) предотвращает повторные обнаружения для одной последовательности.

### Отслеживаемые события
- **OnPlayerKeyStateChange**:
  - Отслеживает нажатия клавиш (приседание, бег, влево/вправо) и смену оружия.
  - Обнаруживает паттерны, такие как приседание или кувырок после выстрела.
  - Пример:
    ```pawn
    if ((newkeys & KEY_CROUCH) && !(oldkeys & KEY_CROUCH)) {
        cbug_d_score_increment = 4.0;
        // Дополнительные проверки для Rollbug, Quick C-switch и т.д.
    }
    ```

- **OnPlayerWeaponShot**:
  - Отслеживает выстрелы и быстрые последовательности.
  - Обновляет оценку для последовательных быстрых выстрелов.
  - Пример:
    ```pawn
    if (cbug_d_time_since_last_shot <= cbug_d_adjusted_shot_threshold) {
        cbug_d_suspicion_score[playerid] += 3.0;
        cbug_d_shot_count[playerid]++;
        cbug_d_last_action_time[playerid] = cbug_d_current_time;
    }
    ```

- **OnPlayerConnect**:
  - Инициализирует состояние обнаружения игрока как отключённое и сбрасывает переменные:
    ```pawn
    cbug_d_player_status[playerid] = false;
    CbugDetection_ResetVariables(playerid);
    ```

### Настройки (Defines)
Defines контролируют поведение обнаружения. Стандартные значения оптимизированы и рекомендуются:

| Define                        | Стандартное значение | Описание                                                                               |
|-------------------------------|----------------------|----------------------------------------------------------------------------------------|
| `CBUG_D_SUSPICION_THRESHOLD`  | 10.0                 | Оценка, необходимая для обнаружения. Большие значения снижают чувствительность.        |
| `CBUG_D_SUSPICION_DECAY`      | 0.5                  | Уменьшение оценки в секунду.                                                          |
| `CBUG_D_SEQUENCE_INTERVAL`    | 1500                 | Окно (**мс**) для действий после выстрела, считающихся подозрительными.                |
| `CBUG_D_SHOT_INTERVAL`        | 200                  | Окно (**мс**) для выявления последовательных быстрых выстрелов.                        |
| `CBUG_D_COOLDOWN_TIME`        | 1500                 | Период восстановления (**мс**) между обнаружениями для избежания повторов.             |
| `CBUG_D_PING_MULTIPLIER`      | 0.01                 | Множитель для корректировки времени по пингу.                                          |
| `CBUG_D_WEAPON_BUFFER_TIME`   | 500                  | Буфер (**мс**) для обнаружения смены оружия после выстрела.                            |
| `CBUG_D_SCORE_RESET_TIME`     | 2000                 | Время (**мс**) после последнего действия для сброса оценки.                           |
| `CBUG_D_VALID_WEAPONS`        | {24, 25, 27, 33, 34} | Отслеживаемое оружие (**Desert Eagle**, **Shotgun**, **SPAS-12**, **Rifle**, **Sniper**). |

> [!WARNING]
> Изменение значений defines не рекомендуется, так как стандартные значения тщательно откалиброваны для баланса точности и производительности.

## Структура кода

Include организован в отдельные секции, каждая из которых выполняет определённую функцию:

1. **Заголовок**:
   - Определяет защиту include (`_cbug_detection_included`) и проверяет включение `a_samp` или `open.mp`.

2. **Настройки (Defines)**:
   - Определяет константы для параметров обнаружения (например, `CBUG_D_SUSPICION_THRESHOLD`).
   - Использует `#if defined` для предотвращения конфликтов переопределения.

3. **Глобальные переменные**:
   - Хранит состояния игроков:
     ```pawn
     static bool:cbug_d_player_status[MAX_PLAYERS]; // Состояние для игрока
     static Float:cbug_d_suspicion_score[MAX_PLAYERS]; // Оценка подозрительности
     static cbug_d_last_fire_time[MAX_PLAYERS]; // Последний выстрел
     // ... другие переменные для отслеживания
     ```

4. **Утилитарные функции (Static Stock)**:
   - Внутренние функции для логики обнаружения:
     - `CbugDetection_GetPingAdjtThresh`: Корректирует время по пингу.
     - `CbugDetection_IsCbugWeapon`: Проверяет отслеживаемое оружие.
     - `CbugDetection_IsJumping`: Обнаруживает анимации прыжка.
     - `CbugDetection_IsRunning`: Обнаруживает анимации бега.
     - `CbugDetection_ResetVariables`: Сбрасывает переменные игрока.
   - Пример:
     ```pawn
     static stock bool:CbugDetection_ResetVariables(playerid)
     {
         if (cbug_d_suspicion_score[playerid] != 0.0)
             cbug_d_suspicion_score[playerid] = 0.0;

         if (cbug_d_last_fire_time[playerid] != 0)
             cbug_d_last_fire_time[playerid] = 0;

         if (cbug_d_last_roll_time[playerid] != 0)
             cbug_d_last_roll_time[playerid] = 0;

         // ... другие переменные для сброса...

         return true;
     }
     ```

5. **Публичные функции (Stock)**:
   - Функции для управления системой:
     - `CbugDetection_Player`: Включает или отключает обнаружение для конкретного игрока.
     - `CbugDetection_IsActive`: Проверяет, активно ли обнаружение для игрока.
   - Пример:
     ```pawn
     stock bool:CbugDetection_Player(playerid, bool:cbug_d_enable) {
         if (!IsPlayerConnected(playerid))
             return false;

         if (cbug_d_enable) {
             if (cbug_d_player_status[playerid])
                 return false;

             cbug_d_player_status[playerid] = true;

             return true;
         }
         else {
             if (!cbug_d_player_status[playerid])
                 return false;

             cbug_d_player_status[playerid] = false;
             CbugDetection_ResetVariables(playerid);
             
             return true;
         }
     }
     ```

6. **Callback'и**:
   - Реализует логику в `OnPlayerKeyStateChange`, `OnPlayerWeaponShot`, `OnPlayerConnect` и `OnPlayerDisconnect`.
   - Предоставляет `CbugDetection_OnDetected` для кастомизации.
   - Пример:
     ```pawn
     forward CbugDetection_OnDetected(playerid);
     ```

7. **ALS Hooks**:
   - Интегрирует стандартные callback'и SA-MP для совместимости:
     ```pawn
     #if defined _ALS_OnPlayerConnect
         #undef OnPlayerConnect
     #else
         #define _ALS_OnPlayerConnect
     #endif
     #define OnPlayerConnect CBUG_D_OnPlayerConnect

     // ... другие ALS определения...
     ```

## Установка и настройка

### Установка
1. **Скачайте Include**:
   - Поместите файл `cbug-detection.inc` в директорию `pawno/include`.

2. **Добавьте в Gamemode**:
   - Добавьте в начало gamemode:
     ```pawn
     #include <a_samp>
     #include <cbug-detection>
     ```

> [!WARNING]
> Убедитесь, что `a_samp` или `open.mp` включены до `cbug-detection.inc`, иначе компилятор выдаст ошибки.

3. **Скомпилируйте Gamemode**:
   - Используйте компилятор **Pawn** для компиляции gamemode, убедитесь в отсутствии ошибок.

### Настройка
- **Определите Callback**:
  - Реализуйте `CbugDetection_OnDetected` в gamemode для обработки обнаружений:
    ```pawn
    public CbugDetection_OnDetected(playerid) {
        new string[100];

        format(string, sizeof(string), "Игрок %d замечен за использованием C-Bug!", playerid);
        SendClientMessageToAll(-1, string);

        return 1;
    }
    ```

## Как использовать

Include предоставляет индивидуальный контроль обнаружения **C-Bug** для каждого игрока. Ниже приведены практические примеры использования:

### Активация для игрока
- Активируйте для конкретного игрока, например, в боевом событии:
  ```pawn
  CbugDetection_Player(playerid, true);
  ```

### Деактивация для игрока
- Отключите для конкретного игрока, например, для администраторов:
  ```pawn
  CbugDetection_Player(playerid, false);
  ```

### Проверка состояния
- Проверьте, активно ли обнаружение для игрока:
  ```pawn
  if (CbugDetection_IsActive(playerid))
      SendClientMessage(playerid, -1, "Обнаружение активно для вас.");
  ```

### Интеграция с античитом
- Применяйте наказания в `CbugDetection_OnDetected`:
  ```pawn
  public CbugDetection_OnDetected(playerid) {
      new string[110], name[MAX_PLAYER_NAME];
      GetPlayerName(playerid, name, sizeof(name));

      format(string, sizeof(string), "Игрок %s (ID: %d) замечен за использованием C-Bug!", name, playerid);
      SendClientMessageToAll(-1, string);

      Kick(playerid);

      return 1;
  }
  ```

### Логирование обнаружений
- Записывайте обнаружения в файл:
  ```pawn
  public CbugDetection_OnDetected(playerid) {
      new string[128], name[MAX_PLAYER_NAME], 
          File:log = fopen("cbug_detections.log", io_append);

      format(string, sizeof(string), "[%s] Игрок %s (ID: %d) замечен за использованием C-Bug\n", GetCurrentDateTime(), name, playerid);

      fwrite(log, string);
      fclose(log);

      return 1;
  }
  ```

### Пример в мини-игре
- Активируйте обнаружение только для конкретных игроков в мини-игре:
  ```pawn
  CMD:iniciarminigame(playerid, params[]) {
      CbugDetection_Player(playerid, true);
      SendClientMessage(playerid, -1, "Обнаружение C-Bug активировано для вас в мини-игре!");

      return 1;
  }

  CMD:finalizarminigame(playerid, params[]) {
      CbugDetection_Player(playerid, false);
      SendClientMessage(playerid, -1, "Обнаружение C-Bug деактивировано для вас!");

      return 1;
  }
  ```

> [!TIP]
> Используйте `CbugDetection_IsActive` для проверки состояния обнаружения перед выполнением условных действий, таких как уведомления или наказания.

## Возможные применения

**Cbug Detection** обладает высокой универсальностью и может использоваться в различных контекстах:

- **Серверы Roleplay (RP)**: Укрепляйте правила против **C-Bug** для реалистичных боёв.
- **Серверы TDM/DM**: Обеспечивайте баланс в боях, обнаруживая **C-Bug**.
- **Мониторинг**: Анализируйте поведение игроков или выявляйте частых нарушителей.
- **Мини-игры и события**: Контролируйте **C-Bug** только в определённых событиях.
- **Пользовательские механики**: Интегрируйте с системами начисления очков или штрафов.

> [!NOTE]
> Возможность сохранять индивидуальные настройки при глобальном включении или отключении делает include идеальным для серверов с динамическими правилами.

## Кастомизация

Хотя include оптимизирован со стандартными настройками, можно настроить defines или callback `CbugDetection_OnDetected`.

> [!WARNING]
> Изменение defines или других настроек **не рекомендуется**, так как стандартные значения протестированы и сбалансированы для максимальной эффективности. Изменения могут привести к ложным срабатываниям, неточным обнаружениям или даже нарушению работы.

### Настройка Defines
- **Серверы с высоким пингом**:
  ```pawn
  #define CBUG_D_SEQUENCE_INTERVAL 2000
  #define CBUG_D_SHOT_INTERVAL 300
  ```

- **Более строгое обнаружение**:
  ```pawn
  #define CBUG_D_SUSPICION_THRESHOLD 15.0
  ```

- **Пользовательское оружие**:
  ```pawn
  #define CBUG_D_VALID_WEAPONS {24, 25, 27, 33, 34}
  ```

### Кастомизация Callback
- Добавьте продвинутую логику:
  ```pawn
  public CbugDetection_OnDetected(playerid) {
      new string[128], name[MAX_PLAYER_NAME];
      static warnings[MAX_PLAYERS];

      GetPlayerName(playerid, name, sizeof(name));
      warnings[playerid]++;

      format(string, sizeof(string), "Предупреждение %d: Игрок %s (ID: %d) замечен за использованием C-Bug!", warnings[playerid], name, playerid);
      SendClientMessageToAll(-1, string);

      if (warnings[playerid] >= 3)
          BanEx(playerid, "Повторное использование C-Bug");
      
      return 1;
  }
  ```

## Тестирование и валидация

Для обеспечения корректной работы выполните следующие тесты:

- **Обнаружение C-Bug**:
  - Протестируйте все перечисленные варианты с отслеживаемым оружием.
  - Убедитесь, что `CbugDetection_OnDetected` срабатывает после **2**-**3** последовательностей.

- **Ложные срабатывания**:
  - Выполните действия, такие как бег, прыжки или стрельба без приседания.
  - Убедитесь, что обнаружения не происходит для действий, не связанных с **C-Bug**.

- **Контроль по игрокам**:
  - Протестируйте `CbugDetection_Player` для активации/деактивации по игрокам.
  - Убедитесь, что обнаружение происходит только для игроков с активным `cbug_d_player_status`.

- **Проверка состояния**:
  - Используйте `CbugDetection_IsActive` для подтверждения состояния по игрокам.

- **OnPlayerConnect**:
  - Убедитесь, что новые игроки начинают с отключённым обнаружением (`cbug_d_player_status = false`).

- **Высокий пинг**:
  - Симулируйте пинг **200**-**300ms** и проверьте точность обнаружения.

- **Производительность**:
  - Протестируйте с **50**+ игроками для подтверждения эффективности.

> [!TIP]
> Тестируйте в контролируемой среде с небольшим количеством игроков перед внедрением на заполненных серверах.

## Ограничения и замечания

- **Зависимость от Callback'ов**:
  - Зависит от `OnPlayerWeaponShot` и `OnPlayerKeyStateChange`, которые могут быть затронуты лагом или другими include'ами.
- **Экстремальный пинг**:
  - Очень высокие задержки (>**500ms**) могут потребовать корректировки `CBUG_D_PING_MULTIPLIER`.
- **Анимации**:
  - Обнаружение бега/прыжков использует индексы анимаций, которые могут варьироваться в модифицированных клиентах.
- **Ложные срабатывания**:
  - Несмотря на надёжность, **ложные срабатывания возможны в редких случаях**, например, при быстрых последовательных легитимных действиях, что считается нормальным.

> [!IMPORTANT]
> **Ложные срабатывания** минимизированы проверками, но могут возникать в атипичных сценариях. Мониторьте обнаружения для корректировки использования при необходимости.

## Лицензия

Этот include защищен лицензией Apache 2.0, которая разрешает:

- ✔️ Коммерческое и частное использование
- ✔️ Модификацию исходного кода
- ✔️ Распространение кода
- ✔️ Предоставление патентов

### Условия:

- Сохранение уведомления об авторских правах
- Документирование значительных изменений
- Включение копии лицензии Apache 2.0

Для получения более подробной информации о лицензии: http://www.apache.org/licenses/LICENSE-2.0

**Copyright (c) Calasans - Все права защищены**